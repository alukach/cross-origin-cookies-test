<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<title>Cross Origin Cookie Test</title>
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.6.0/styles/default.min.css" />
	</head>

	<body>
		<button id="postApiCall">Get Cookie (POST)</button>
		<button id="getApiCall">Test Cookie (GET)</button>
		<button id="clearToken">Remove Cookie (DELETE)</button>

		<pre id="apiResponse"></pre>

		<img id="testImage" src="https://cross-origin-cookie-test.alukach.workers.dev/image" />

		<details>
			<summary>API Code</summary>
			<pre style="font-size: 0.75rem">
        <code class="javascript">
export interface Env {}

const frontendUrl = 'https://cross-origin-cookie-test.alukach.com';

export default {
  async fetch(request: Request, env: Env, ctx: ExecutionContext): Promise<Response> {
    const headers = {
      'Access-Control-Allow-Origin': frontendUrl, // NOTE: This cannot be a wildcard
      'Access-Control-Allow-Methods': 'GET, POST, DELETE, OPTIONS',
      'Access-Control-Allow-Headers': 'Content-Type, credentials',
      'Access-Control-Allow-Credentials': 'true',
    };

    // Handle CORS preflight requests
    if (request.method === 'OPTIONS') {
      return new Response(null, {
        headers: {
          ...headers,
          Vary: 'Origin',
        },
      });
    }

    // Extract cookies from request
    const cookieHeader = request.headers.get('Cookie') || '';
    const cookies = cookieHeader.split(';').reduce<Record<string, string>>((acc, current) => {
      const [name, value] = current.trim().split('=');
      acc[name] = value;
      return acc;
    }, {});

    // Handle POST requests
    if (request.method === 'POST') {
      const body = { message: 'Hello from the API' };
      return new Response(JSON.stringify(body), {
        headers: {
          ...headers,
          'Content-Type': 'application/json',
          'Set-Cookie': `api_token=${Math.floor(Date.now() / 1000)}; SameSite=None; Secure; Path=/`,
        },
      });
    }

    // Handle DELETE requests
    if (request.method === 'DELETE') {
      const body = { message: 'Deleted the cookie' };
      return new Response(JSON.stringify(body), {
        headers: {
          ...headers,
          'Content-Type': 'application/json',
          'Set-Cookie': `api_token=; SameSite=None; Secure; Path=/; Expires=${new Date(0).toUTCString()}`,
        },
      });
    }

    // Handle GET requests
    if (request.method === 'GET') {
      if (!cookies['api_token']) {
        return new Response('Unauthorized', {
          headers,
          status: 401,
        });
      }

      if (new URL(request.url).pathname === '/image') {
        const imageResponse = await fetch('https://picsum.photos/200/300');

        // Convert the response body to a Uint8Array
        const bodyArrayBuffer = await imageResponse.arrayBuffer();
        const body = new Uint8Array(bodyArrayBuffer);

        // Clone the response so we can modify headers
        const modifiedResponse = new Response(body, imageResponse);

        // Set CORS headers to allow the image to be shared with the origin site
        modifiedResponse.headers.set('Access-Control-Allow-Origin', frontendUrl);
        modifiedResponse.headers.set('Access-Control-Allow-Credentials', 'true');
        modifiedResponse.headers.set('Vary', 'Origin'); // Ensures cache varies based on Origin header

        return modifiedResponse;
      }

      const body = { message: 'Cookie validated successfully' };
      return new Response(JSON.stringify(body), {
        status: 200,
        headers: {
          ...headers,
          'Content-Type': 'application/json',
        },
      });
    }

    // Catch-all for other requests
    return new Response('Method not allowed', {
      status: 405,
      headers,
    });
  },
};
        </code>
      </pre>  
		</details>

		<script>
			const url = 'https://cross-origin-cookie-test.alukach.workers.dev';

			document.getElementById('postApiCall').addEventListener('click', async () => {
				const response = await fetch(url, {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
					},
					credentials: 'include', // Required to set cookie in browser
					body: JSON.stringify({ data: 'Hello from the static site' }),
				});
				document.getElementById('apiResponse').textContent = `Status: ${response.status}, Response: ${await response.text()}`;
				updateImage();
			});

			document.getElementById('getApiCall').addEventListener('click', async () => {
				const response = await fetch(url, {
					method: 'GET',
					credentials: 'include', // Required to include cookie in fetch calls
				});
				document.getElementById('apiResponse').textContent = `Status: ${response.status}, Response: ${await response.text()}`;
			});

			document.getElementById('clearToken').addEventListener('click', async () => {
				const response = await fetch(url, {
					method: 'DELETE',
					credentials: 'include', // Required to remove cookie in browser
				});
				document.getElementById('apiResponse').textContent = `Status: ${response.status}, Response: ${await response.text()}`;
				updateImage();
			});

			function updateImage() {
				const image = document.getElementById('testImage');
				const url = new URL(image.src);
				const nonce = Math.floor(Date.now() / 1000);

				url.searchParams.has('t') ? url.searchParams.set('t', nonce) : url.searchParams.append('t', nonce);

				image.src = url.toString();
			}
		</script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.6.0/highlight.min.js"></script>
		<script>
			hljs.highlightAll();
		</script>
	</body>
</html>
